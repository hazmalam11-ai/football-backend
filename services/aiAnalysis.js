const Groq = require('groq-sdk');
const Analysis = require('../models/Analysis');

// ===============================
// ๐ค ุชููุฆุฉ Groq AI
// ===============================
const groq = new Groq({
  apiKey: process.env.GROQ_API_KEY
});

// ===============================
// ๐ ูุงููุณ ุงูุชุฑุฌูุฉ ุงูุดุงูู
// ===============================
const TRANSLATIONS = {
  teams: {
    "Manchester United": "ูุงูุดุณุชุฑ ูููุงูุชุฏ",
    "Manchester City": "ูุงูุดุณุชุฑ ุณูุชู",
    "Liverpool": "ูููุฑุจูู",
    "Chelsea": "ุชุดููุณู",
    "Arsenal": "ุขุฑุณูุงู",
    "Tottenham Hotspur": "ุชูุชููุงู ููุชุณุจูุฑ",
    "Newcastle United": "ููููุงุณู ูููุงูุชุฏ",
    "Aston Villa": "ุฃุณุชูู ูููุง",
    "West Ham United": "ูุณุช ูุงู ูููุงูุชุฏ",
    "Brighton": "ุจุฑุงูุชูู",
    "Everton": "ุฅููุฑุชูู",
    "Leicester City": "ููุณุชุฑ ุณูุชู",
    
    // ๐ช๐ธ ุงููุฑู ุงูุฅุณุจุงููุฉ
    "Real Madrid": "ุฑูุงู ูุฏุฑูุฏ",
    "Barcelona": "ุจุฑุดูููุฉ",
    "FC Barcelona": "ุจุฑุดูููุฉ",
    "Atletico Madrid": "ุฃุชูุชููู ูุฏุฑูุฏ",
    "Sevilla": "ุฅุดุจูููุฉ",
    "Valencia": "ูุงููุณูุง",
    "Real Betis": "ุฑูุงู ุจูุชูุณ",
    "Real Sociedad": "ุฑูุงู ุณูุณูุฏุงุฏ",
    "Athletic Bilbao": "ุฃุชูุชูู ุจููุจุงู",
    "Villarreal": "ููุงุฑูุงู",
    
    // ๐ฎ๐น ุงููุฑู ุงูุฅูุทุงููุฉ
    "Juventus": "ููููุชูุณ",
    "Inter Milan": "ุฅูุชุฑ ูููุงู",
    "AC Milan": "ูููุงู",
    "Napoli": "ูุงุจููู",
    "Roma": "ุฑููุง",
    "AS Roma": "ุฑููุง",
    "Lazio": "ูุงุชุณูู",
    "Atalanta": "ุฃุชุงูุงูุชุง",
    "Fiorentina": "ูููุฑูุชููุง",
    
    // ๐ฉ๐ช ุงููุฑู ุงูุฃููุงููุฉ
    "Bayern Munich": "ุจุงูุฑู ููููุฎ",
    "Borussia Dortmund": "ุจูุฑูุณูุง ุฏูุฑุชูููุฏ",
    "RB Leipzig": "ูุงูุจุฒูุบ",
    "Bayer Leverkusen": "ุจุงูุฑ ูููุฑููุฒู",
    "Eintracht Frankfurt": "ุขููุชุฑุงุฎุช ูุฑุงููููุฑุช",
    "Union Berlin": "ูููููู ุจุฑููู",
    
    // ๐ซ๐ท ุงููุฑู ุงููุฑูุณูุฉ
    "Paris Saint-Germain": "ุจุงุฑูุณ ุณุงู ุฌูุฑูุงู",
    "PSG": "ุจุงุฑูุณ ุณุงู ุฌูุฑูุงู",
    "Marseille": "ูุงุฑุณูููุง",
    "Lyon": "ูููู",
    "Monaco": "ูููุงูู",
    "Lille": "ููู",
    "Nice": "ููุณ",
    
    // ๐ช๐ฌ ุงููุฑู ุงููุตุฑูุฉ
    "Al Ahly": "ุงูุฃููู",
    "Zamalek": "ุงูุฒูุงูู",
    "Pyramids": "ุจูุฑุงููุฏุฒ",
    "Al Masry": "ุงููุตุฑู",
    
    // ๐ธ๐ฆ ุงููุฑู ุงูุณุนูุฏูุฉ
    "Al Hilal": "ุงูููุงู",
    "Al Nassr": "ุงููุตุฑ",
    "Al Ittihad": "ุงูุงุชุญุงุฏ",
    "Al Ahli": "ุงูุฃููู",
    "Al Shabab": "ุงูุดุจุงุจ",
    
    // ๐ฆ๐ช ุงููุฑู ุงูุฅูุงุฑุงุชูุฉ
    "Al Ain": "ุงูุนูู",
    "Al Wahda": "ุงููุญุฏุฉ",
    "Sharjah": "ุงูุดุงุฑูุฉ"
  },
  
  // ๐ ุงูุฏูุฑูุงุช ูุงูุจุทููุงุช
  tournaments: {
    "Premier League": "ุงูุฏูุฑู ุงูุฅูุฌููุฒู ุงูููุชุงุฒ",
    "La Liga": "ุงูุฏูุฑู ุงูุฅุณุจุงูู",
    "Serie A": "ุงูุฏูุฑู ุงูุฅูุทุงูู",
    "Bundesliga": "ุงูุฏูุฑู ุงูุฃููุงูู",
    "Ligue 1": "ุงูุฏูุฑู ุงููุฑูุณู",
    "UEFA Champions League": "ุฏูุฑู ุฃุจุทุงู ุฃูุฑูุจุง",
    "UEFA Europa League": "ุงูุฏูุฑู ุงูุฃูุฑูุจู",
    "FIFA World Cup": "ูุฃุณ ุงูุนุงูู",
    "Egyptian Premier League": "ุงูุฏูุฑู ุงููุตุฑู ุงูููุชุงุฒ",
    "Saudi Pro League": "ุฏูุฑู ุฑูุดู ุงูุณุนูุฏู",
    "CAF Champions League": "ุฏูุฑู ุฃุจุทุงู ุฃูุฑูููุง",
    "AFC Champions League": "ุฏูุฑู ุฃุจุทุงู ุขุณูุง"
  },
  
  // โฝ ุงููุฑุงูุฒ
  positions: {
    "forward": "ููุงุฌู",
    "striker": "ููุงุฌู ุตุฑูุญ",
    "winger": "ุฌูุงุญ",
    "left winger": "ุฌูุงุญ ุฃูุณุฑ",
    "right winger": "ุฌูุงุญ ุฃููู",
    "midfielder": "ูุงุนุจ ูุณุท",
    "defensive midfielder": "ูุงุนุจ ูุณุท ุฏูุงุนู",
    "attacking midfielder": "ุตุงูุน ุฃูุนุงุจ",
    "central midfielder": "ูุงุนุจ ูุณุท ูุญูุฑู",
    "defender": "ูุฏุงูุน",
    "center back": "ููุจ ุฏูุงุน",
    "full back": "ุธููุฑ",
    "left back": "ุธููุฑ ุฃูุณุฑ",
    "right back": "ุธููุฑ ุฃููู",
    "goalkeeper": "ุญุงุฑุณ ูุฑูู"
  },
  
  // ๐ฏ ุงูุชูุชููุงุช
  tactics: {
    "4-3-3": "ุฃุฑุจุนุฉ ุซูุงุซุฉ ุซูุงุซุฉ",
    "4-4-2": "ุฃุฑุจุนุฉ ุฃุฑุจุนุฉ ุงุซูุงู",
    "3-5-2": "ุซูุงุซุฉ ุฎูุณุฉ ุงุซูุงู",
    "4-2-3-1": "ุฃุฑุจุนุฉ ุงุซูุงู ุซูุงุซุฉ ูุงุญุฏ",
    "3-4-3": "ุซูุงุซุฉ ุฃุฑุจุนุฉ ุซูุงุซุฉ",
    "possession": "ุงูุงุณุชุญูุงุฐ ุนูู ุงููุฑุฉ",
    "counter-attack": "ุงููุฌูุงุช ุงููุฑุชุฏุฉ",
    "high press": "ุงูุถุบุท ุงูุนุงูู",
    "tiki-taka": "ุงูุชูุฑูุฑุงุช ุงููุตูุฑุฉ ุงููุชุชุงููุฉ",
    "long ball": "ุงููุฑุงุช ุงูุทูููุฉ",
    "park the bus": "ุงูุฏูุงุน ุงูููุซู"
  }
};

// ===============================
// ๐ง ุฏุงูุฉ ูุณุงุนุฏุฉ: ุงูุญุตูู ุนูู ูุนุฑู ุงููุจุงุฑุงุฉ
// ===============================
function getMatchId(data) {
  return data.matchId || data.apiId || data._id || data.fixture?.id || 
         `${data.homeTeam?.id}-${data.awayTeam?.id}-${new Date(data.date).getTime()}`;
}

// ===============================
// ๐ ุชุฑุฌูุฉ ุงุณู ุงููุฑูู
// ===============================
function translateTeamName(name) {
  return TRANSLATIONS.teams[name] || name;
}

// ===============================
// ๐ ุชุฑุฌูุฉ ุงุณู ุงูุจุทููุฉ
// ===============================
function translateTournament(name) {
  return TRANSLATIONS.tournaments[name] || name;
}

// ===============================
// ๐ ุจูุงุก ุณูุงู ุงููุจุงุฑุงุฉ
// ===============================
function buildMatchContext(matchData) {
  const homeNameEn = matchData.homeTeam.name;
  const awayNameEn = matchData.awayTeam.name;
  const homeNameAr = translateTeamName(homeNameEn);
  const awayNameAr = translateTeamName(awayNameEn);
  const tournamentAr = translateTournament(matchData.tournament.name);
  
  const score = `${matchData.score?.home || matchData.scoreA || 0} - ${matchData.score?.away || matchData.scoreB || 0}`;
  const dateStr = new Date(matchData.date).toLocaleDateString('ar-EG', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  return {
    homeNameEn,
    awayNameEn,
    homeNameAr,
    awayNameAr,
    tournamentAr,
    score,
    dateStr,
    venue: matchData.venue || 'ุบูุฑ ูุญุฏุฏ',
    statistics: matchData.statistics || null
  };
}

// ===============================
// ๐ ุจูุงุก Prompt ุงุญุชุฑุงูู ูุชูุฏู
// ===============================
function buildPrompt(matchData) {
  const ctx = buildMatchContext(matchData);
  
  let prompt = `
ุฃูุช ูุญูู ูุฑุฉ ูุฏู ุนุฑุจู ูุญุชุฑู ุชุนูู ูุฃูุจุฑ ุงูููุตุงุช ุงูุฑูุงุถูุฉ ุงูุนุงูููุฉ ูุซู BBC Sport ู beIN SPORTS ู ESPN.

๐ **ูุนูููุงุช ุงููุจุงุฑุงุฉ:**
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐๏ธ **ุงููุจุงุฑุงุฉ:** ${ctx.homeNameAr} (${ctx.homeNameEn}) ุถุฏ ${ctx.awayNameAr} (${ctx.awayNameEn})
โฝ **ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:** ${ctx.score}
๐ **ุงูุจุทููุฉ:** ${ctx.tournamentAr} (${matchData.tournament.name})
๐ **ุงูููุนุจ:** ${ctx.venue}
๐ **ุงูุชุงุฑูุฎ:** ${ctx.dateStr}
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;

  // ุฅุถุงูุฉ ุงูุฅุญุตุงุฆูุงุช ุฅุฐุง ูุงูุช ูุชููุฑุฉ
  if (ctx.statistics) {
    prompt += `\n๐ **ุงูุฅุญุตุงุฆูุงุช ุงููุชุงุญุฉ:**\n`;
    if (ctx.statistics.possession) {
      prompt += `- ุงูุงุณุชุญูุงุฐ: ${ctx.homeNameAr} ${ctx.statistics.possession.home}% - ${ctx.statistics.possession.away}% ${ctx.awayNameAr}\n`;
    }
    if (ctx.statistics.shots) {
      prompt += `- ุงูุชุณุฏูุฏุงุช: ${ctx.homeNameAr} ${ctx.statistics.shots.home} - ${ctx.statistics.shots.away} ${ctx.awayNameAr}\n`;
    }
    if (ctx.statistics.shotsOnTarget) {
      prompt += `- ุงูุชุณุฏูุฏุงุช ุนูู ุงููุฑูู: ${ctx.homeNameAr} ${ctx.statistics.shotsOnTarget.home} - ${ctx.statistics.shotsOnTarget.away} ${ctx.awayNameAr}\n`;
    }
    if (ctx.statistics.corners) {
      prompt += `- ุงูุฑูููุงุช: ${ctx.homeNameAr} ${ctx.statistics.corners.home} - ${ctx.statistics.corners.away} ${ctx.awayNameAr}\n`;
    }
    if (ctx.statistics.fouls) {
      prompt += `- ุงููุฎุงููุงุช: ${ctx.homeNameAr} ${ctx.statistics.fouls.home} - ${ctx.statistics.fouls.away} ${ctx.awayNameAr}\n`;
    }
    if (ctx.statistics.yellowCards) {
      prompt += `- ุงูุจุทุงูุงุช ุงูุตูุฑุงุก: ${ctx.homeNameAr} ${ctx.statistics.yellowCards.home} - ${ctx.statistics.yellowCards.away} ${ctx.awayNameAr}\n`;
    }
    if (ctx.statistics.redCards) {
      prompt += `- ุงูุจุทุงูุงุช ุงูุญูุฑุงุก: ${ctx.homeNameAr} ${ctx.statistics.redCards.home} - ${ctx.statistics.redCards.away} ${ctx.awayNameAr}\n`;
    }
    prompt += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n`;
  }

  prompt += `
๐ฏ **ูููุชู:**
ุงูุชุจ ุชุญูููุงู ูููุงู ุดุงููุงู ูููุจุงุฑุงุฉ ุจุฃุณููุจ ุงุญุชุฑุงูู ูุฌูุน ุจูู ุงูุนูู ุงูุชุญูููู ูุงูุณูุงุณุฉ ูู ุงูุณุฑุฏ.

๐ **ูููู ุงูุชุญููู ุงููุทููุจ:**

**1๏ธโฃ ุงูููุฎุต ุงูุชูููุฐู** (250-350 ูููุฉ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โข ุงุจุฏุฃ ุจุฌููุฉ ุงูุชุชุงุญูุฉ ูููุฉ ูุฌุฐุงุจุฉ ุชูุฎุต ุฌููุฑ ุงููุจุงุฑุงุฉ
โข ุงุฐูุฑ ุงููุชูุฌุฉ ูุฃูููุชูุง ูู ุณูุงู ุงูุจุทููุฉ ูุงูููุณู
โข ุตู ุงูุฃุฌูุงุก ุงูุนุงูุฉ ูููุจุงุฑุงุฉ (ูุซูุฑุฉุ ูุชูุงุฒูุฉุ ุฃุญุงุฏูุฉ ุงูุฌุงูุจ)
โข ุฃุจุฑุฒ ุงููุญุธุงุช ุงููุงุตูุฉ ูุงูุฃูุฏุงู ุงููุณุฌูุฉ
โข ุงุฐูุฑ ุชุฃุซูุฑ ุงููุชูุฌุฉ ุนูู ุชุฑุชูุจ ุงููุฑูููู
โข ุงุณุชุฎุฏู ูุบุฉ ุญูููุฉ ููุตููุฉ ูุซู:
  - "ูู ููุงุฌูุฉ ููุชูุจุฉ ุนูู ุฃุฑุถ..."
  - "ุดูุฏุช ุงููุจุงุฑุงุฉ ุชุญููุงู ุฏุฑุงูุงุชูููุงู..."
  - "ุฃุธูุฑ ุงููุฑูู ุฃุฏุงุกู ุงุณุชุซูุงุฆูุงู..."
  - "ูุงูุช ุงููุจุงุฑุงุฉ ุจูุซุงุจุฉ ุตุฑุงุน ุฅุฑุงุฏุงุช..."

**2๏ธโฃ ุชุญููู ุงูุฃุฏุงุก ุงูููู** (400-500 ูููุฉ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ต **ุฃุฏุงุก ${ctx.homeNameAr}:**
**ุงูุฏูุงุน:**
โข ุงูุชูุธูู ุงูุฏูุงุนู ูุงูุชุบุทูุฉ
โข ุฃุฏุงุก ุฎุท ุงูุฏูุงุน ูููุจ ุงูุฏูุงุน ุชุญุฏูุฏุงู
โข ุงูุชุนุงูู ูุน ุงููุฑุงุช ุงูุนุงููุฉ ูุงูุซุงุจุชุฉ
โข ููุงุท ุงูููุฉ ูุงูุถุนู ุงูุฏูุงุนูุฉ

**ุงููุณุท:**
โข ุงูุณูุทุฑุฉ ุนูู ููุชุตู ุงูููุนุจ
โข ุฏูุฉ ุงูุชูุฑูุฑุงุช ูุฅููุงุน ุงููุนุจ
โข ุงูุชูุงุฒู ุจูู ุงูุฏูุงุน ูุงููุฌูู
โข ุฏูุฑ ุตุงูุน ุงูุฃูุนุงุจ

**ุงููุฌูู:**
โข ุงูุญุฑูุฉ ุงููุฌูููุฉ ูุงูุงุฎุชุฑุงูุงุช
โข ููุงุกุฉ ุงูุชูุฏูู ูุงููุฑุต ุงูุถุงุฆุนุฉ
โข ุงูุชูุงูู ุจูู ุฎุท ุงููุฌูู
โข ุงููุนุจ ุนูู ุงูุฃุทุฑุงู ููุงุจู ุงููุฑูุฒ

**ุงูุฑูุญ ูุงูุงูุชุฒุงู:**
โข ุงูุฑูุญ ุงููุชุงููุฉ ูุฑุฏ ุงููุนู
โข ุงูุงูุถุจุงุท ุงูุชูุชููู
โข ุงูุชุฑููุฒ ุงูุฐููู ูู ุงููุญุธุงุช ุงูุญุงุณูุฉ

๐ด **ุฃุฏุงุก ${ctx.awayNameAr}:**
[ููุณ ุงูุชุญููู ุงูุชูุตููู ูููุฑูู ุงูุถูู]

**3๏ธโฃ ุงูุชุญููู ุงูุชูุชููู** (300-400 ูููุฉ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฏ **ุฎุทุฉ ${ctx.homeNameAr}:**
โข ุงูุชุดูููุฉ ุงููุณุชุฎุฏูุฉ (ูุซู: 4-3-3ุ 4-2-3-1)
โข ุงูููุณูุฉ ุงูุชูุชูููุฉ (ุงุณุชุญูุงุฐุ ูุฌูู ูุฑุชุฏุ ุถุบุท ุนุงูู)
โข ุงูููุงู ุงููุฑุฏูุฉ ููุงุนุจูู ุงูุฑุฆูุณููู
โข ุงูุชุนุฏููุงุช ุฎูุงู ุงููุจุงุฑุงุฉ

๐ฏ **ุฎุทุฉ ${ctx.awayNameAr}:**
[ููุณ ุงูุชุญููู ุงูุชูุชููู]

โ๏ธ **ุงูููุงุฑูุฉ ุงูุชูุชูููุฉ:**
โข ุฃู ุชูุชูู ูุงู ุฃูุซุฑ ูุนุงููุฉ ูููุงุฐุงุ
โข ุงููุนุงุฑู ุงูุชูุชูููุฉ ุงูุฑุฆูุณูุฉ (ูุณุท ุงูููุนุจุ ุงูุฃุทุฑุงูุ ุงููุณุงุญุงุช)
โข ุฏูุฑ ุงููุฏุฑุจูู ูุงูุชุจุฏููุงุช ุงูุชูุชูููุฉ
โข ููุงุท ุงูุชุญูู ุงูุชูุชูููุฉ ูู ุงููุจุงุฑุงุฉ

**4๏ธโฃ ุงููุงุนุจูู ุงููุคุซุฑูู** (200-300 ูููุฉ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุงุฎุชุฑ 3-5 ูุงุนุจูู ูุงู ููู ุงูุฃุซุฑ ุงูุฃูุจุฑ:

๐ **[ุงุณู ุงููุงุนุจ 1] - [ุงููุฑูุฒ]**
โข ุฏูุฑู ูู ุงููุจุงุฑุงุฉ ุจุงูุชูุตูู
โข ุงูุฅุญุตุงุฆูุงุช ุงูุจุงุฑุฒุฉ (ุฃูุฏุงูุ ุชูุฑูุฑุงุช ุญุงุณูุฉุ ุงุณุชุฎูุงุตุงุช)
โข ุงููุญุธุงุช ุงููุคุซุฑุฉ
โข ุงูุชูููู ูู 10

๐ **[ุงุณู ุงููุงุนุจ 2]**
[ููุณ ุงูุชูุงุตูู]

ุงุณุชุฎุฏู ุฃูุตุงูุงู ุงุญุชุฑุงููุฉ ูุซู:
- "ูุฌู ุงูููุงุก ุจูุง ููุงุฒุน"
- "ุงูุฑุฌู ุงูุฐู ุตูุน ุงููุงุฑู"
- "ุฃุฏุงุก ูุงุจุชู ุงููุฑูู ูุงู ููููุงู"
- "ุฃุธูุฑ ููุงุฑุงุช ุงุณุชุซูุงุฆูุฉ"

**5๏ธโฃ ุชุญููู ุงูุฅุญุตุงุฆูุงุช** (150-200 ูููุฉ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${ctx.statistics ? 'โข ุญูู ุงูุฅุญุตุงุฆูุงุช ุงููุชููุฑุฉ ุฃุนูุงู' : 'โข ุญูู ุงูุฃุฑูุงู ุงููุชููุนุฉ ุจูุงุกู ุนูู ุงููุชูุฌุฉ'}
โข ุงุฑุจุท ุงูุฃุฑูุงู ุจุงูุฃุฏุงุก ุงููุนูู
โข ูู ุงูุฅุญุตุงุฆูุงุช ุชุนูุณ ุณูุฑ ุงููุจุงุฑุงุฉุ
โข ุงููุคุดุฑุงุช ุงูุฃูุซุฑ ุฏูุงูุฉ

**6๏ธโฃ ููุงุท ุงูููุฉ ูุงูุถุนู:**
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ **ููุงุท ููุฉ ${ctx.homeNameAr}:**
1. [ููุทุฉ ููุฉ ูุญุฏุฏุฉ ูุน ุดุฑุญ]
2. [ููุทุฉ ููุฉ ูุญุฏุฏุฉ ูุน ุดุฑุญ]
3. [ููุทุฉ ููุฉ ูุญุฏุฏุฉ ูุน ุดุฑุญ]
4. [ููุทุฉ ููุฉ ูุญุฏุฏุฉ ูุน ุดุฑุญ]
5. [ููุทุฉ ููุฉ ูุญุฏุฏุฉ ูุน ุดุฑุญ]

โ **ููุงุท ุถุนู ${ctx.homeNameAr}:**
1. [ููุทุฉ ุถุนู ูุญุฏุฏุฉ ูุน ุดุฑุญ]
2. [ููุทุฉ ุถุนู ูุญุฏุฏุฉ ูุน ุดุฑุญ]
3. [ููุทุฉ ุถุนู ูุญุฏุฏุฉ ูุน ุดุฑุญ]
4. [ููุทุฉ ุถุนู ูุญุฏุฏุฉ ูุน ุดุฑุญ]

โ **ููุงุท ููุฉ ${ctx.awayNameAr}:**
[ููุณ ุงูุชูุตูู]

โ **ููุงุท ุถุนู ${ctx.awayNameAr}:**
[ููุณ ุงูุชูุตูู]

**7๏ธโฃ ุงูุฎูุงุตุฉ ุงููููุฉ** (100-150 ูููุฉ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โข ุชูููู ุดุงูู ูููุจุงุฑุงุฉ
โข ูู ูุณุชุญู ุงูููุฒ ูููุงุฐุงุ
โข ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ
โข ุงูุชุทูุนุงุช ุงููุณุชูุจููุฉ ูููุฑูููู
โข ุชุฃุซูุฑ ุงููุชูุฌุฉ ุนูู ุงูููุณู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ **ุดุฑูุท ุฅูุฒุงููุฉ:**

โ **ุงููุบุฉ ูุงูุฃุณููุจ:**
โข ุงุณุชุฎุฏู ุงูุนุฑุจูุฉ ุงููุตุญู ุงูุญุฏูุซุฉ (ููุณุช ููุงุณูููุฉ ุฌุงูุฏุฉ)
โข ููููุน ููุนุงู ุจุงุชุงู ุงุณุชุฎุฏุงู ุฃู ูููุงุช ุฃู ุฃุญุฑู ุฅูุฌููุฒูุฉ
โข ูุง ุชุฐูุฑ IDs ุฃู ุฑููุฒ ุฃู ุฃููุงุฏ
โข ุงุณุชุฎุฏู ุฃุณูุงุก ุงููุฑู ุจุงูุนุฑุจูุฉ: ${ctx.homeNameAr} ู ${ctx.awayNameAr}
โข ุงุณุชุฎุฏู ูุตุทูุญุงุช ูุฑููุฉ ุงุญุชุฑุงููุฉ ุนุฑุจูุฉ

โ **ุงูููุถูุนูุฉ:**
โข ูู ูุญุงูุฏุงู ูููุตูุงู ุชูุงูุงู
โข ูุง ุชูุญุงุฒ ูุฃู ูุฑูู
โข ุงุนุชูุฏ ุนูู ุงูุญูุงุฆู ูุงูุฃุฏุงุก ุงููุนูู

โ **ุงูุฃุณููุจ:**
โข ุงูุชุจ ุจุฃุณููุจ ูุญูู ุชููุฒูููู ูุญุชุฑู
โข ุงุฌุนู ุงูุชุญููู ุณูุณุงู ูููุชุนุงู ูููุฑุงุกุฉ
โข ุงุณุชุฎุฏู ุนุจุงุฑุงุช ุงูุชูุงููุฉ (ุนูุงูุฉ ุนูู ุฐููุ ูู ูุงุญูุฉ ุฃุฎุฑูุ ุจุงูุฅุถุงูุฉ ุฅูู)
โข ุชุฌูุจ ุงูุชูุฑุงุฑ ูุงูุญุดู
โข ูู ุฌููุฉ ูุฌุจ ุฃู ุชุถูู ูุนูููุฉ ุฌุฏูุฏุฉ

โ **ุงูุณูุงู:**
โข ุงุฑุจุท ุงูุฃุญุฏุงุซ ุจุณูุงู ุงูุฏูุฑู ูุงูุชุฑุชูุจ
โข ุงุฐูุฑ ุงูุฃูููุฉ ุงูุชุงุฑูุฎูุฉ ุฅู ูุฌุฏุช
โข ุชุญุฏุซ ุนู ุชุฃุซูุฑ ุงููุชูุฌุฉ ุนูู ุงูุณุจุงูุงุช (ุงูููุจุ ุงููุจูุทุ ุงูุชุฃูู)

โ **ุงูุงุญุชุฑุงููุฉ:**
โข ูุง ุชุณุชุฎุฏู ุชุนุจูุฑุงุช ุนุงููุฉ
โข ุชุฌูุจ ุงูุฅูุดุงุก ุงูุฒุงุฆุฏ
โข ุฑูุฒ ุนูู ุงูุชุญููู ุงูููู ุงูุนููู
โข ุงุณุชุฎุฏู ุจูุงูุงุช ูุฃุฑูุงู ูุญุฏุฏุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงุจุฏุฃ ุงูุชุญููู ุงูุขู ุจุฃุณููุจ ุงุญุชุฑุงูู ุนุงููู:
`;

  return prompt;
}

// ===============================
// ๐ฏ ุชุญููู ุงููุจุงุฑุงุฉ - ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
// ===============================
async function analyzeMatch(matchData) {
  const startTime = Date.now();
  
  try {
    // ุงูุญุตูู ุนูู ูุนุฑู ุงููุจุงุฑุงุฉ
    const matchId = getMatchId(matchData);
    
    if (!matchId) {
      throw new Error('โ ูุนุฑู ุงููุจุงุฑุงุฉ ุบูุฑ ูุชููุฑ');
    }
    
    const ctx = buildMatchContext(matchData);
    console.log(`\n๐ฏ ุจุฏุก ุชุญููู ุงููุจุงุฑุงุฉ:`);
    console.log(`   ๐ ${ctx.homeNameAr} vs ${ctx.awayNameAr}`);
    console.log(`   ๐ ${ctx.tournamentAr}`);
    console.log(`   โฝ ุงููุชูุฌุฉ: ${ctx.score}`);
    console.log(`   ๐ ูุนุฑู ุงููุจุงุฑุงุฉ: ${matchId}`);
    
    // ุงูุชุญูู ูู ูุฌูุฏ ุชุญููู ุณุงุจู
    const existingAnalysis = await Analysis.findOne({ matchId });
    
    if (existingAnalysis) {
      console.log(`   โ๏ธ  ุชุญููู ููุฌูุฏ ูุณุจูุงู - ุชุฎุทู ุงูุชูููุฏ`);
      return existingAnalysis;
    }
    
    console.log(`   ๐ค ุงุณุชุฏุนุงุก AI ููุชุญููู...`);
    
    // ุจูุงุก ุงูู Prompt
    const prompt = buildPrompt(matchData);
    
    // ุงุณุชุฏุนุงุก Groq AI
    const completion = await groq.chat.completions.create({
      messages: [
        {
          role: 'system',
          content: `ุฃูุช ูุญูู ูุฑุฉ ูุฏู ุนุฑุจู ูุญุชุฑู ูู ุงูุทุฑุงุฒ ุงูุนุงููู ุชุนูู ูุฃูุจุฑ ุงูููุตุงุช ุงูุฑูุงุถูุฉ.

๐ฏ **ูููุชู:**
- ูุชุงุจุฉ ุชุญูููุงุช ุงุญุชุฑุงููุฉ ุดุงููุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู
- ุงุณุชุฎุฏุงู ุฃุณููุจ ูุญูู ุชููุฒูููู ูุญุชุฑู (ูุซู BBC Sportุ beIN SPORTS)
- ุงูุชุฑููุฒ ุนูู ุงูุนูู ุงูุชุญูููู ูุงูููุถูุนูุฉ

โ๏ธ **ููุงุนุฏ ุตุงุฑูุฉ:**
- ุงููุบุฉ ุงูุนุฑุจูุฉ ููุท - ููููุน ุฃู ูููุงุช ุฅูุฌููุฒูุฉ
- ูุง ุชุฐูุฑ IDs ุฃู ุฑููุฒ ุฃู ุฃููุงุฏ
- ุงุณุชุฎุฏู ุฃุณูุงุก ุงููุฑู ูุงูุจุทููุงุช ุจุงูุนุฑุจูุฉ
- ูู ููุถูุนูุงู ููุญุงูุฏุงู ุชูุงูุงู
- ุงูุชุจ ุจุฃุณููุจ ุจุดุฑู ุทุจูุนู ูุงุญุชุฑุงูู
- ุงุณุชุฎุฏู ูุตุทูุญุงุช ูุฑููุฉ ุฏูููุฉ

๐จ **ุงูุฃุณููุจ ุงููุทููุจ:**
- ุชุญููู ุนููู ูุดุงูู
- ูุบุฉ ุณูุณุฉ ูููุชุนุฉ ูููุฑุงุกุฉ  
- ุฑุจุท ุงูุฃุญุฏุงุซ ุจุงูุณูุงู
- ุงุณุชุฎุฏุงู ุนุจุงุฑุงุช ุงูุชูุงููุฉ
- ุชุฌูุจ ุงูุชูุฑุงุฑ ูุงูุญุดู`
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      model: "llama-3.3-70b-versatile",
      temperature: 0.7,
      max_tokens: 4000,
      top_p: 0.9,
      frequency_penalty: 0.3,
      presence_penalty: 0.2
    });
    
    const fullText = completion.choices[0].message.content;
    const processingTime = Date.now() - startTime;
    
    console.log(`   โ ุชู ุงูุชุญููู ุจูุฌุงุญ ูู ${processingTime}ms`);
    console.log(`   ๐ ุทูู ุงูุชุญููู: ${fullText.length} ุญุฑู`);
    
    // ุฅูุดุงุก ูุงุฆู ุงูุชุญููู
    const analysis = new Analysis({
      matchId,
      
      homeTeam: {
        id: matchData.homeTeam.id,
        name: matchData.homeTeam.name,
        logo: matchData.homeTeam.logo
      },
      
      awayTeam: {
        id: matchData.awayTeam.id,
        name: matchData.awayTeam.name,
        logo: matchData.awayTeam.logo
      },
      
      score: {
        home: matchData.score?.home || matchData.scoreA || 0,
        away: matchData.score?.away || matchData.scoreB || 0
      },
      
      tournament: {
        id: matchData.tournament.id,
        name: matchData.tournament.name,
        nameAr: ctx.tournamentAr,
        country: matchData.tournament.country,
        logo: matchData.tournament.logo
      },
      
      venue: matchData.venue,
      date: new Date(matchData.date),
      status: matchData.status || 'FT',
      
      analysis: {
        fullText,
        summary: fullText.substring(0, 500) + '...' // ููุฎุต ุณุฑูุน
      },
      
      aiModel: "groq-llama-3.3-70b-versatile",
      processingTime,
      isPublished: true,
      views: 0,
      likes: 0
    });
    
    // ุญูุธ ุงูุชุญููู
    await analysis.save();
    
    console.log(`   ๐พ ุชู ุญูุธ ุงูุชุญููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช`);
    console.log(`   ๐ ุงูุชูู ุจูุฌุงุญ!\n`);
    
    return analysis;
    
  } catch (error) {
    console.error(`\nโ ุฎุทุฃ ูู ุชุญููู ุงููุจุงุฑุงุฉ:`);
    console.error(`   ุงูุฎุทุฃ: ${error.message}`);
    console.error(`   ุงูุชูุงุตูู: ${error.stack}\n`);
    
    // ุฅุฑุฌุงุน ุชุญููู ุงุญุชูุงุทู
    console.log(`   ๐ ุงุณุชุฎุฏุงู ุงูุชุญููู ุงูุงุญุชูุงุทู...`);
    return fallbackAnalysis(matchData);
  }
}

// ===============================
// ๐ ุชุญููู ุงุญุชูุงุทู (Fallback)
// ===============================
function fallbackAnalysis(matchData) {
  const ctx = buildMatchContext(matchData);
  const matchId = getMatchId(matchData);
  
  const fallbackText = `
**ุชุญููู ูุจุงุฑุงุฉ ${ctx.homeNameAr} ุถุฏ ${ctx.awayNameAr}**

ุงูุชูุช ุงููุจุงุฑุงุฉ ุงูุชู ุฌูุนุช ุจูู ${ctx.homeNameAr} ู${ctx.awayNameAr} ูู ุฅุทุงุฑ ููุงูุณุงุช ${ctx.tournamentAr} ุจูุชูุฌุฉ ${ctx.score}.

ุฃูููุช ุงููุจุงุฑุงุฉ ุนูู ููุนุจ ${ctx.venue} ููู ${ctx.dateStr}ุ ูุดูุฏุช ููุงูุณุฉ ูููุฉ ุจูู ุงููุฑูููู.

**ููุงุญุธุฉ:** ุงูุชุญููู ุงูุชูุตููู ุงููุงูู ููุฏ ุงููุนุงูุฌุฉ ูุณูุชู ุชูููุฑู ูุฑูุจุงู. ูุดูู ุงูุชุญููู ุงููุงูู:
- ุชูููู ุงูุฃุฏุงุก ุงูููู ููู ูุฑูู
- ุงูุชุญููู ุงูุชูุชููู ุงูููุตูู
- ุฃุจุฑุฒ ุงููุงุนุจูู ุงููุคุซุฑูู
- ุงูุฅุญุตุงุฆูุงุช ูุงูุฃุฑูุงู
- ููุงุท ุงูููุฉ ูุงูุถุนู
- ุงูุฎูุงุตุฉ ุงููููุฉ ุงูุดุงููุฉ

ูุฑุฌู ุงูุนูุฏุฉ ูุงุญูุงู ููุงุทูุงุน ุนูู ุงูุชุญููู ุงููุงูู.
`;

  return {
    matchId,
    homeTeam: matchData.homeTeam,
    awayTeam: matchData.awayTeam,
    score: {
      home: matchData.score?.home || matchData.scoreA || 0,
      away: matchData.score?.away || matchData.scoreB || 0
    },
    tournament: matchData.tournament,
    date: matchData.date,
    analysis: {
      fullText: fallbackText,
      summary: fallbackText.substring(0, 300)
    },
    aiModel: "fallback",
    processingTime: 0,
    isPublished: false
  };
}

// ===============================
// ๐ ุชุญููู ูุจุงุฑูุงุช ูุชุนุฏุฏุฉ
// ===============================
async function analyzeMultipleMatches(matches, options = {}) {
  const {
    batchSize = 5,           // ุนุฏุฏ ุงููุจุงุฑูุงุช ูู ูู ุฏูุนุฉ
    delayBetweenBatches = 2000, // ุงูุชุฃุฎูุฑ ุจูู ุงูุฏูุนุงุช (ูููู ุซุงููุฉ)
    continueOnError = true    // ุงูุงุณุชูุฑุงุฑ ุนูุฏ ุญุฏูุซ ุฎุทุฃ
  } = options;
  
  console.log(`\n๐ ุจุฏุก ุชุญููู ${matches.length} ูุจุงุฑุงุฉ...`);
  console.log(`   ๐ฆ ุญุฌู ุงูุฏูุนุฉ: ${batchSize} ูุจุงุฑูุงุช`);
  console.log(`   โฑ๏ธ  ุงูุชุฃุฎูุฑ ุจูู ุงูุฏูุนุงุช: ${delayBetweenBatches}ms\n`);
  
  const results = [];
  const errors = [];
  
  // ุชูุณูู ุงููุจุงุฑูุงุช ุฅูู ุฏูุนุงุช
  for (let i = 0; i < matches.length; i += batchSize) {
    const batch = matches.slice(i, i + batchSize);
    const batchNumber = Math.floor(i / batchSize) + 1;
    const totalBatches = Math.ceil(matches.length / batchSize);
    
    console.log(`๐ฆ ูุนุงูุฌุฉ ุงูุฏูุนุฉ ${batchNumber}/${totalBatches} (${batch.length} ูุจุงุฑูุงุช)...`);
    
    // ูุนุงูุฌุฉ ุงููุจุงุฑูุงุช ูู ุงูุฏูุนุฉ ุจุดูู ูุชูุงุฒู
    const batchPromises = batch.map(async (match, index) => {
      try {
        const result = await analyzeMatch(match);
        return { success: true, data: result, match };
      } catch (error) {
        console.error(`   โ ูุดู ุชุญููู ุงููุจุงุฑุงุฉ ${i + index + 1}: ${error.message}`);
        return { success: false, error: error.message, match };
      }
    });
    
    const batchResults = await Promise.all(batchPromises);
    
    // ุชุตููู ุงููุชุงุฆุฌ
    batchResults.forEach(result => {
      if (result.success) {
        results.push(result.data);
      } else {
        errors.push(result);
        if (!continueOnError) {
          throw new Error(`ูุดู ุชุญููู ูุจุงุฑุงุฉ: ${result.error}`);
        }
      }
    });
    
    console.log(`   โ ุงูุชููุช ุงูุฏูุนุฉ ${batchNumber}: ${results.length} ูุฌุญุชุ ${errors.length} ูุดูุช\n`);
    
    // ุงูุชุธุงุฑ ูุจู ุงูุฏูุนุฉ ุงูุชุงููุฉ (ุชุฌูุจ ุงูุถุบุท ุนูู API)
    if (i + batchSize < matches.length) {
      console.log(`   โณ ุงูุชุธุงุฑ ${delayBetweenBatches}ms ูุจู ุงูุฏูุนุฉ ุงูุชุงููุฉ...\n`);
      await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));
    }
  }
  
  console.log(`\n๐ ุงูุชููุช ูุนุงูุฌุฉ ุฌููุน ุงููุจุงุฑูุงุช!`);
  console.log(`   โ ูุฌุญ: ${results.length}`);
  console.log(`   โ ูุดู: ${errors.length}\n`);
  
  return {
    success: results,
    failed: errors,
    stats: {
      total: matches.length,
      successful: results.length,
      failed: errors.length,
      successRate: ((results.length / matches.length) * 100).toFixed(2) + '%'
    }
  };
}

// ===============================
// ๐ ุฅุนุงุฏุฉ ุชุญููู ูุจุงุฑุงุฉ ููุฌูุฏุฉ
// ===============================
async function reanalyzeMatch(matchId) {
  try {
    console.log(`\n๐ ุฅุนุงุฏุฉ ุชุญููู ุงููุจุงุฑุงุฉ: ${matchId}`);
    
    const existingAnalysis = await Analysis.findOne({ matchId });
    
    if (!existingAnalysis) {
      throw new Error('ุงููุจุงุฑุงุฉ ุบูุฑ ููุฌูุฏุฉ');
    }
    
    // ุญุฐู ุงูุชุญููู ุงููุฏูู
    await Analysis.deleteOne({ matchId });
    console.log(`   ๐๏ธ  ุชู ุญุฐู ุงูุชุญููู ุงููุฏูู`);
    
    // ุฅุนุงุฏุฉ ุงูุชุญููู
    const matchData = {
      matchId: existingAnalysis.matchId,
      homeTeam: existingAnalysis.homeTeam,
      awayTeam: existingAnalysis.awayTeam,
      score: existingAnalysis.score,
      tournament: existingAnalysis.tournament,
      venue: existingAnalysis.venue,
      date: existingAnalysis.date
    };
    
    const newAnalysis = await analyzeMatch(matchData);
    console.log(`   โ ุชู ุฅุนุงุฏุฉ ุงูุชุญููู ุจูุฌุงุญ\n`);
    
    return newAnalysis;
    
  } catch (error) {
    console.error(`\nโ ูุดูุช ุฅุนุงุฏุฉ ุงูุชุญููู: ${error.message}\n`);
    throw error;
  }
}

// ===============================
// ๐ค ุงูุตุงุฏุฑุงุช
// ===============================
module.exports = {
  analyzeMatch,
  analyzeMultipleMatches,
  reanalyzeMatch,
  translateTeamName,
  translateTournament,
  buildMatchContext
};
